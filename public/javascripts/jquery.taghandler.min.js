(function($){$.fn.tagHandler=function(options){var opts=$.extend({},$.fn.tagHandler.defaults,options);tagDebug($(this),opts);return this.each(function(){if(!$(this).is('ul')){next}if(!this.id){var d=new Date();this.id=d.getTime()}var tagContainer=this;$(tagContainer).wrap('<div class="'+opts.className+'" />');$(tagContainer).addClass(opts.className+"Container");if(opts.allowEdit){$(tagContainer).html('<li class="tagInput"><input class="tagInputField" type="text" /></li>')}var inputField=$(tagContainer).find(".tagInputField");var tags=new Array();tags['availableTags']=new Array();tags['originalTags']=new Array();tags['assignedTags']=new Array();if(opts.updateURL!=''){if(!opts.autoUpdate){$("<div />").attr({id:tagContainer.id+"_save",title:"Save Tags"}).addClass("tagUpdate").click(function(){saveTags(tags,opts,tagContainer.id)}).appendTo($(tagContainer).parent())}$("<div />").attr({id:tagContainer.id+"_loader",title:"Saving Tags"}).addClass("tagLoader").appendTo($(tagContainer).parent())}if(opts.getURL!=''){$.ajax({url:opts.getURL,cache:false,data:opts.getData,dataType:'json',success:function(data,text,xhr){if(data.availableTags.length){tags['availableTags']=data.availableTags.slice();tags['originalTags']=tags['availableTags'].slice()}if(opts.sortTags){tags=sortTags(tags)}if(data.assignedTags.length){tags['assignedTags']=data.assignedTags.slice();if(opts.sortTags){tags=sortTags(tags)}for(var x=0;x<tags['assignedTags'].length;x++){if(opts.allowEdit){$("<li />").addClass("tagItem").html(tags['assignedTags'][x]).insertBefore($(inputField).parent())}else{$("<li />").addClass("tagItem").css("cursor","default").html(tags['assignedTags'][x]).appendTo($(tagContainer))}tags['availableTags']=removeTagFromList(tags['assignedTags'][x],tags['availableTags'])}}if(opts.autocomplete&&opts.allowEdit){$(inputField).autocomplete("option","source",tags['availableTags'])}},error:function(xhr,text,error){alert("There was an error getting the tag list.")}})}else{if(opts.availableTags.length){tags['availableTags']=opts.availableTags.slice();tags['originalTags']=tags.availableTags.slice()}if(opts.sortTags){tags=sortTags(tags)}if(opts.assignedTags.length){tags['assignedTags']=opts.assignedTags.slice();if(opts.sortTags){tags=sortTags(tags)}for(var x=0;x<tags['assignedTags'].length;x++){if(opts.allowEdit){$("<li />").addClass("tagItem").html(tags['assignedTags'][x]).insertBefore($(inputField).parent())}else{$("<li />").addClass("tagItem").css("cursor","default").html(tags['assignedTags'][x]).appendTo($(tagContainer))}tags['availableTags']=removeTagFromList(tags['assignedTags'][x],tags['availableTags'])}}if(opts.autocomplete&&opts.allowEdit){$(inputField).autocomplete("option","source",tags['availableTags'])}}if(opts.allowEdit){$(tagContainer).delegate("#"+this.id+" li.tagItem","click",function(){tags=removeTag($(this),tags,opts.sortTags);if(opts.updateURL!=''&&opts.autoUpdate){saveTags(tags,opts,tagContainer.id)}if(opts.autocomplete){$(inputField).autocomplete("option","source",tags['availableTags'])}});$(inputField).keypress(function(e){if(e.which==13||e.which==44||e.which==opts.delimiter.charCodeAt(0)){e.preventDefault();if($(this).val()!=""&&!checkTag($.trim($(this).val()),tags['assignedTags'])){tags=addTag(this,$.trim($(this).val()),tags,opts.sortTags);if(opts.updateURL!=''&&opts.autoUpdate){saveTags(tags,opts,tagContainer.id)}if(opts.autocomplete){$(inputField).autocomplete("option","source",tags['availableTags'])}$(this).val("");$(this).focus()}}});$(inputField).keydown(function(e){if(e.which==8&&$(this).val()==""){tags=removeTag($(tagContainer).find(".tagItem:last"),tags,opts.sortTags);if(opts.updateURL!=''&&opts.autoUpdate){saveTags(tags,opts,tagContainer.id)}if(opts.autocomplete){$(inputField).autocomplete("option","source",tags['availableTags'])}$(this).focus()}});if(opts.autocomplete){$(inputField).autocomplete({source:tags['availableTags'],select:function(event,ui){if(!checkTag($.trim(ui.item.value),tags['assignedTags'])){tags=addTag(this,$.trim(ui.item.value),tags,opts.sortTags);if(opts.updateURL!=''&&opts.autoUpdate){saveTags(tags,opts,tagContainer.id)}$(inputField).autocomplete("option","source",tags['availableTags']);$(this).focus()}$(this).val("");return false},minLength:0})}$(tagContainer).click(function(){$(inputField).focus().blur().focus();if($(inputField).val()==""&&opts.autocomplete){$(inputField).autocomplete("search","")}})}})};$.fn.tagHandler.defaults={allowEdit:true,assignedTags:[],autocomplete:false,autoUpdate:false,availableTags:[],className:'tagHandler',debug:false,delimiter:'',getData:'',getURL:'',sortTags:true,updatetData:'',updateURL:''};function checkTag(value,tags){var check=false;for(var x=0;x<tags.length;x++){if(tags[x]==value){check=true;break}}return check}function removeTagFromList(value,tags){for(var x=0;x<tags.length;x++){if(tags[x]==value){tags.splice(x,1)}}return tags}function addTag(tagField,value,tags,sort){tags['assignedTags'].push(value);tags['availableTags']=removeTagFromList(value,tags['availableTags']);$("<li />").addClass("tagItem").html(value).insertBefore($(tagField).parent());if(sort){tags=sortTags(tags)}return tags}function removeTag(tag,tags,sort){var value=$(tag).html();tags['assignedTags']=removeTagFromList(value,tags['assignedTags']);if(checkTag(value,tags['originalTags'])){tags['availableTags'].push(value)}$(tag).remove();if(sort){tags=sortTags(tags)}return tags}function sortTags(tags){tags['availableTags']=tags['availableTags'].sort();tags['assignedTags']=tags['assignedTags'].sort();tags['originalTags']=tags['originalTags'].sort();return tags}function saveTags(tags,opts,tcID){sendData={tags:tags.assignedTags};$.extend(sendData,opts.updateData);$.ajax({type:'POST',url:opts.updateURL,cache:false,data:sendData,dataType:'json',beforeSend:function(){if($("#"+tcID+"_save").length){$("#"+tcID+"_save").fadeOut(200,function(){$("#"+tcID+"_loader").fadeIn(200)})}else{$("#"+tcID+"_loader").fadeIn(200)}},complete:function(){$("#"+tcID+"_loader").fadeOut(200,function(){if($("#"+tcID+"_save").length){$("#"+tcID+"_save").fadeIn(200)}})}})}function tagDebug(tagContainer,options){if(window.console&&window.console.log&&options.debug){window.console.log(tagContainer);window.console.log(options);window.console.log($.fn.tagHandler.defaults)}}})(jQuery);